using GS.Server.Alignment;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using System;
using System.Reflection;
using GS.Server.SkyTelescope;

namespace AlignmentModelTests
{
    [TestClass]
    public class AlignmentPointTests
    {
        private const double SiteLatitude = 56.76d;
        private const double SiteLongitude = -5.85d;
        private const double SiteElevation = 10d;
        private const double DecHome = 90d;
        private const double RaHome = 90d;
        private const double DoubleDelta = 0.0001;

        private AlignmentModel _alignmentModel;

        [TestInitialize]
        public void Initialize()
        {
            _alignmentModel = new AlignmentModel(SiteLatitude, SiteLongitude, SiteElevation);
            _alignmentModel.Connect(RaHome, DecHome, SkyServer.StepsPerRevolution);
        }


        [TestCleanup]
        public void Cleanup()
        {
            _alignmentModel.SaveAlignmentPoints();
            _alignmentModel.SaveAlignmentPoints("c:\\temp\\points.GssPointModel");
        }

        [DataRow(1, 63.7072912837969, 130.765779672163, -6362574.26365272, -5669178.81281457, 64.8118388623703, 130.054634580634, -6394088.34382722, -5740971.42865165, "2023-02-18T22:14:10.2711916+00:00")]
        [DataRow(2, 72.6895039420807, 127.202036499902, -6395853.43271088, -6289435.47093027, 73.7963078628305, 126.429440743229, -6446323.77133478, -6342659.90511636, "2023-02-18T22:15:36.4788489+00:00")]
        [DataRow(3, 69.5094535018456, 138.971945042359, -5203993.35218848, -6333425.46295972, 70.6622759349463, 138.24296132692, -5216908.75031288, -6424246.54652379, "2023-02-18T22:16:50.8398587+00:00")]
        [DataRow(4, 103.280927760896, 119.356817705725, -6416346.24883387, -7983613.52205834, 104.455621559399, 118.499219360669, -6568213.92040585, -7944250.98274713, "2023-02-18T22:19:13.3089842+00:00")]
        [DataRow(5, 88.9675783630117, 116.282491977609, -7437614.84724742, -6611199.94232817, 90.0485961716324, 115.457326067169, -7556953.53953105, -6568365.9432696, "2023-02-18T22:20:27.5642388+00:00")]
        [DataRow(6, 118.369267797886, 53.721736998103, -6925671.10345979, 5326333.04850026, 119.721777456959, 52.8103789020268, -6874220.8883211, 5250539.94686291, "2023-02-18T22:30:58.5941017+00:00")]
        [DataRow(7, 134.307342530302, 55.7319439806278, -7578094.92770562, 3905202.13885189, 135.566546400331, 54.8419698722453, -7526064.21714702, 3830788.96694707, "2023-02-18T22:39:34.7371358+00:00")]
        [DataRow(8, 151.624147401657, 160.768667221069, 7430438.06085565, -6482397.73781354, 150.881763483797, 158.317946374478, 7256397.86321309, -6885351.58004947, "2023-02-21T16:54:27.3473950+00:00")]
        [DataRow(9, 153.920972400345, 164.317242622375, 7795727.78515725, -5736530.52862917, 149.075523365393, 161.99654546719, 7031400.06357129, -6698692.47073293, "2023-02-21T16:54:46.8400208+00:00")]
        [DataRow(10, 149.97487965459, 163.44481086731, 7195338.24552472, -6414561.76188735, 135.566546400331, 161.015757545441, 4717588.68539074, -8080263.65069342, "2023-02-21T16:55:08.1970993+00:00")]
        [DataRow(11, 10.3571483418345, 42.4416313171387, 10321072.4083304, 5768916.20495222, 9.98312045419137, 41.5784877238403, 10472384.4189073, 5378105.28079772, "2023-02-21T17:04:41.6258831+00:00")]
        [DataRow(12, 47.2411897489801, 46.5827674865723, -166193.418341569, 10776330.5685321, 49.6139950035978, 44.8784207024449, -52469.2032596495, 10607877.8497628, "2023-02-21T17:05:35.2794739+00:00")]
        [DataRow(13, 39.6334795570001, 29.2168731689453, 4748248.40654001, 8969548.40351501, 39.5056752076461, 27.1335995026076, 4985260.8788508, 8700383.69082606, "2023-02-21T17:06:03.1718644+00:00")]
        [DataRow(14, 32.5539813963696, 40.9920616149902, 4332584.58466646, 10191725.1932098, 33.7936498434583, 38.8532364127109, 4528065.28505237, 9929436.11212896, "2023-02-21T17:12:05.4596214+00:00")]
        [DataRow(15, 71.4433331852779, -5.47232484817505, 2188405.37016954, 6509731.64762416, 70.9550865110171, -8.32493446885006, 2348405.61046347, 6286147.84801046, "2023-02-22T16:32:37.9968259+00:00")]
        [DataRow(16, 96.738184762653, 8.92612838745117, -1231780.67106983, 6640252.88124053, 97.5159988725873, 6.37980805446013, -1114657.04042988, 6474281.81865728, "2023-02-22T16:32:57.0650492+00:00")]
        [DataRow(17, 127.951965399086, 27.7023468017578, -4887599.89036269, 4804436.08467582, 129.087121918086, 26.0683804176742, -4806894.23491529, 4690247.07415026, "2023-02-22T16:33:16.0947377+00:00")]
        [DataRow(18, 176.611702694558, 38.2026557922363, -6833469.76294762, 318941.691259505, 177.436793844801, 37.8581850491166, -6810503.58672093, 241417.892508973, "2023-02-22T16:33:34.6241197+00:00")]
        [DataRow(19, 59.9051308981143, 160.27667427063, -3814411.53372199, -5358329.35164219, 60.9236732290687, 159.330114552247, -3831200.15048376, -5460009.2008869, "2023-02-22T16:34:59.2192499+00:00")]
        [DataRow(20, 107.330581681337, 180.53249078989, 1833547.95836841, -6883993.8875524, 104.057130641919, 175.492619578988, 1188382.02804933, -7206761.37591283, "2023-02-22T16:36:28.4874948+00:00")]
        [DataRow(21, 132.541225377936, 197.808704376221, 4881138.04884325, -4849554.82831679, 135.508615026067, 196.210280535264, 5183072.65787681, -4804555.84078948, "2023-02-22T16:38:00.9547928+00:00")]
        [DataRow(22, 170.225447353907, 203.537979125977, 7058114.93449423, -1127215.8374043, 169.16592005199, 200.75416758752, 7220517.0167183, -1318677.22053997, "2023-02-22T16:38:23.8915431+00:00")]
        [DataRow(23, 52.2835953999311, -15.7011318206787, 4429062.43761177, 5262560.12065232, 50.2891638194146, -17.3595020833354, 4616934.02465876, 5032607.43350225, "2023-02-22T16:39:04.5726025+00:00")]
        [DataRow(24, 98.3893305580132, 8.92612838745117, -1377126.47704587, 6546340.93151104, 99.1901291282206, 6.39956609226504, -1261127.14330319, 6382368.00528762, "2023-02-22T16:39:32.0497045+00:00")]
        [DataRow(25, 145.953060870524, 31.555549621582, -5876926.15601041, 3195613.65840555, 146.983785975744, 30.4233559810059, -5818974.83601423, 3098692.61096334, "2023-02-22T16:40:03.2850995+00:00")]
        [DataRow(26, 133.865347368643, 52.2778282165527, -7251706.18090239, 4058722.90639966, 135.061999359148, 51.3428023092868, -7199013.09526496, 3981263.91504407, "2023-02-22T16:40:29.5871521+00:00")]
        [DataRow(27, 56.0707386573777, 10.9492712020874, 3369306.44825976, 7747250.78704212, 55.5951779879302, 8.38388165679172, 3563323.62776977, 7502796.73325463, "2023-02-22T16:40:57.5244142+00:00")]
        [DataRow(28, 8.77692764764652, -10.2242298126221, 8000384.11033479, 1319029.59607129, 7.32919959850292, -7.58666357904799, 8224533.50729175, 1162415.46963518, "2023-02-22T16:41:46.8961391+00:00")]
        [DataRow(29, -4.06386877968907, 3.33107709884644, 9070272.61233436, -801047.938963675, -3.00527556501349, 6.11488863730301, 9287933.60763885, -627038.969511185, "2023-02-22T16:42:18.8927560+00:00")]
        [DataRow(30, 144.574125832412, 172.999776363373, 6443152.6761584, -6079744.38798095, 139.659111668297, 173.124117967508, 5765073.46786116, -6530547.2739313, "2023-02-22T16:43:28.4949610+00:00")]
        [DataRow(31, 103.416064747144, 148.162391662598, -1319946.55650448, -8780127.8325729, 106.688823525492, 153.2022628735, -333176.08935843, -8717918.50374405, "2023-02-22T16:43:49.5240327+00:00")]
        [DataRow(32, 51.2246908177622, 118.375015258789, -8024779.72841905, -4066433.71204136, 50.11969742013, 119.086160350319, -7975714.05457834, -4022565.85587374, "2023-02-22T16:44:09.9189747+00:00")]
        [DataRow(33, 172.642290727235, 90.6335830688477, -10612399.2759139, -27890.0242056412, 171.816668160254, 90.9780538119674, -10636773.5184692, -48411.6151401354, "2023-02-22T16:44:59.4023222+00:00")]
        [DataRow(34, 138.221556268167, 133.976829528809, 915063.177836065, -10930157.7755902, 134.948908591155, 128.936958317906, -1353148.09684954, -10959708.34566, "2023-02-22T16:45:21.8681687+00:00")]
        [DataRow(35, 170.641103023198, 138.95405960083, 10643214.1567786, -4971688.95995501, 173.555888761996, 138.079768281318, 11250058.8453912, -3723782.87921006, "2023-02-22T16:46:17.9570573+00:00")]
        [DataRow(36, 27.7764768693596, 56.6650581359863, -2326692.61347873, 11639727.1424781, 25.4027303148217, 58.3694049201137, -3576428.77788792, 11431944.2795257, "2023-02-22T16:46:57.7741634+00:00")]
        [DataRow(37, 160.170414838474, 108.593780517578, -10897608.1212881, -4389196.42341118, 161.274297801183, 107.882635426048, -11050802.1401184, -3914146.14885643, "2023-02-22T16:47:33.3789428+00:00")]
        [DataRow(38, 166.957052564248, 130.054588317871, 7152803.69502901, -9904122.47596046, 167.699808075733, 132.505309164462, 8679639.19245728, -8432986.69565104, "2023-02-22T16:47:51.8233376+00:00")]
        [DataRow(39, 180.642392088193, 159.463901519775, 10349540.867592, 183864.092471194, 180.64244012648, 159.463901519775, 10349540.5896989, 183877.838664585, "2023-02-26T21:05:39.0586382+00:00")]
        [DataRow(40, 187.496527047362, 163.621063232422, 9837826.67216066, 1920792.19567023, 187.49534086064, 163.621063232422, 9837893.52708983, 1920496.56004675, "2023-02-26T21:06:37.6198267+00:00")]
        [DataTestMethod]
        public void Test_AddingPoints(int id, double unsyncedRA, double unsyncedDec, double unsynchedX, double unsyncedY, double syncedRA, double syncedDec, double synchedX, double syncedY, string syncTime)
        {
            _alignmentModel.SyncToRaDec(new double[] { unsyncedRA, unsyncedDec }, new double[] { syncedRA, syncedDec }, DateTime.Parse(syncTime));

        }

        [DataRow(1, 63.7072912837969, 130.765779672163, -6362574.26365272, -5669178.81281457, 64.8118388623703, 130.054634580634, -6394088.34382722, -5740971.42865165, "2023-02-18T22:14:10.2711916+00:00")]
        [DataRow(2, 72.6895039420807, 127.202036499902, -6395853.43271088, -6289435.47093027, 73.7963078628305, 126.429440743229, -6446323.77133478, -6342659.90511636, "2023-02-18T22:15:36.4788489+00:00")]
        [DataRow(3, 69.5094535018456, 138.971945042359, -5203993.35218848, -6333425.46295972, 70.6622759349463, 138.24296132692, -5216908.75031288, -6424246.54652379, "2023-02-18T22:16:50.8398587+00:00")]
        [DataRow(4, 103.280927760896, 119.356817705725, -6416346.24883387, -7983613.52205834, 104.455621559399, 118.499219360669, -6568213.92040585, -7944250.98274713, "2023-02-18T22:19:13.3089842+00:00")]
        [DataRow(5, 88.9675783630117, 116.282491977609, -7437614.84724742, -6611199.94232817, 90.0485961716324, 115.457326067169, -7556953.53953105, -6568365.9432696, "2023-02-18T22:20:27.5642388+00:00")]
        [DataRow(6, 118.369267797886, 53.721736998103, -6925671.10345979, 5326333.04850026, 119.721777456959, 52.8103789020268, -6874220.8883211, 5250539.94686291, "2023-02-18T22:30:58.5941017+00:00")]
        [DataRow(7, 134.307342530302, 55.7319439806278, -7578094.92770562, 3905202.13885189, 135.566546400331, 54.8419698722453, -7526064.21714702, 3830788.96694707, "2023-02-18T22:39:34.7371358+00:00")]
        [DataRow(8, 151.624147401657, 160.768667221069, 7430438.06085565, -6482397.73781354, 150.881763483797, 158.317946374478, 7256397.86321309, -6885351.58004947, "2023-02-21T16:54:27.3473950+00:00")]
        [DataRow(9, 153.920972400345, 164.317242622375, 7795727.78515725, -5736530.52862917, 149.075523365393, 161.99654546719, 7031400.06357129, -6698692.47073293, "2023-02-21T16:54:46.8400208+00:00")]
        [DataRow(10, 149.97487965459, 163.44481086731, 7195338.24552472, -6414561.76188735, 135.566546400331, 161.015757545441, 4717588.68539074, -8080263.65069342, "2023-02-21T16:55:08.1970993+00:00")]
        [DataRow(11, 10.3571483418345, 42.4416313171387, 10321072.4083304, 5768916.20495222, 9.98312045419137, 41.5784877238403, 10472384.4189073, 5378105.28079772, "2023-02-21T17:04:41.6258831+00:00")]
        [DataRow(12, 47.2411897489801, 46.5827674865723, -166193.418341569, 10776330.5685321, 49.6139950035978, 44.8784207024449, -52469.2032596495, 10607877.8497628, "2023-02-21T17:05:35.2794739+00:00")]
        [DataRow(13, 39.6334795570001, 29.2168731689453, 4748248.40654001, 8969548.40351501, 39.5056752076461, 27.1335995026076, 4985260.8788508, 8700383.69082606, "2023-02-21T17:06:03.1718644+00:00")]
        [DataRow(14, 32.5539813963696, 40.9920616149902, 4332584.58466646, 10191725.1932098, 33.7936498434583, 38.8532364127109, 4528065.28505237, 9929436.11212896, "2023-02-21T17:12:05.4596214+00:00")]
        [DataRow(15, 71.4433331852779, -5.47232484817505, 2188405.37016954, 6509731.64762416, 70.9550865110171, -8.32493446885006, 2348405.61046347, 6286147.84801046, "2023-02-22T16:32:37.9968259+00:00")]
        [DataRow(16, 96.738184762653, 8.92612838745117, -1231780.67106983, 6640252.88124053, 97.5159988725873, 6.37980805446013, -1114657.04042988, 6474281.81865728, "2023-02-22T16:32:57.0650492+00:00")]
        [DataRow(17, 127.951965399086, 27.7023468017578, -4887599.89036269, 4804436.08467582, 129.087121918086, 26.0683804176742, -4806894.23491529, 4690247.07415026, "2023-02-22T16:33:16.0947377+00:00")]
        [DataRow(18, 176.611702694558, 38.2026557922363, -6833469.76294762, 318941.691259505, 177.436793844801, 37.8581850491166, -6810503.58672093, 241417.892508973, "2023-02-22T16:33:34.6241197+00:00")]
        [DataRow(19, 59.9051308981143, 160.27667427063, -3814411.53372199, -5358329.35164219, 60.9236732290687, 159.330114552247, -3831200.15048376, -5460009.2008869, "2023-02-22T16:34:59.2192499+00:00")]
        [DataRow(20, 107.330581681337, 180.53249078989, 1833547.95836841, -6883993.8875524, 104.057130641919, 175.492619578988, 1188382.02804933, -7206761.37591283, "2023-02-22T16:36:28.4874948+00:00")]
        [DataRow(21, 132.541225377936, 197.808704376221, 4881138.04884325, -4849554.82831679, 135.508615026067, 196.210280535264, 5183072.65787681, -4804555.84078948, "2023-02-22T16:38:00.9547928+00:00")]
        [DataRow(22, 170.225447353907, 203.537979125977, 7058114.93449423, -1127215.8374043, 169.16592005199, 200.75416758752, 7220517.0167183, -1318677.22053997, "2023-02-22T16:38:23.8915431+00:00")]
        [DataRow(23, 52.2835953999311, -15.7011318206787, 4429062.43761177, 5262560.12065232, 50.2891638194146, -17.3595020833354, 4616934.02465876, 5032607.43350225, "2023-02-22T16:39:04.5726025+00:00")]
        [DataRow(24, 98.3893305580132, 8.92612838745117, -1377126.47704587, 6546340.93151104, 99.1901291282206, 6.39956609226504, -1261127.14330319, 6382368.00528762, "2023-02-22T16:39:32.0497045+00:00")]
        [DataRow(25, 145.953060870524, 31.555549621582, -5876926.15601041, 3195613.65840555, 146.983785975744, 30.4233559810059, -5818974.83601423, 3098692.61096334, "2023-02-22T16:40:03.2850995+00:00")]
        [DataRow(26, 133.865347368643, 52.2778282165527, -7251706.18090239, 4058722.90639966, 135.061999359148, 51.3428023092868, -7199013.09526496, 3981263.91504407, "2023-02-22T16:40:29.5871521+00:00")]
        [DataRow(27, 56.0707386573777, 10.9492712020874, 3369306.44825976, 7747250.78704212, 55.5951779879302, 8.38388165679172, 3563323.62776977, 7502796.73325463, "2023-02-22T16:40:57.5244142+00:00")]
        [DataRow(28, 8.77692764764652, -10.2242298126221, 8000384.11033479, 1319029.59607129, 7.32919959850292, -7.58666357904799, 8224533.50729175, 1162415.46963518, "2023-02-22T16:41:46.8961391+00:00")]
        [DataRow(29, -4.06386877968907, 3.33107709884644, 9070272.61233436, -801047.938963675, -3.00527556501349, 6.11488863730301, 9287933.60763885, -627038.969511185, "2023-02-22T16:42:18.8927560+00:00")]
        [DataRow(30, 144.574125832412, 172.999776363373, 6443152.6761584, -6079744.38798095, 139.659111668297, 173.124117967508, 5765073.46786116, -6530547.2739313, "2023-02-22T16:43:28.4949610+00:00")]
        [DataRow(31, 103.416064747144, 148.162391662598, -1319946.55650448, -8780127.8325729, 106.688823525492, 153.2022628735, -333176.08935843, -8717918.50374405, "2023-02-22T16:43:49.5240327+00:00")]
        [DataRow(32, 51.2246908177622, 118.375015258789, -8024779.72841905, -4066433.71204136, 50.11969742013, 119.086160350319, -7975714.05457834, -4022565.85587374, "2023-02-22T16:44:09.9189747+00:00")]
        [DataRow(33, 172.642290727235, 90.6335830688477, -10612399.2759139, -27890.0242056412, 171.816668160254, 90.9780538119674, -10636773.5184692, -48411.6151401354, "2023-02-22T16:44:59.4023222+00:00")]
        [DataRow(34, 138.221556268167, 133.976829528809, 915063.177836065, -10930157.7755902, 134.948908591155, 128.936958317906, -1353148.09684954, -10959708.34566, "2023-02-22T16:45:21.8681687+00:00")]
        [DataRow(35, 170.641103023198, 138.95405960083, 10643214.1567786, -4971688.95995501, 173.555888761996, 138.079768281318, 11250058.8453912, -3723782.87921006, "2023-02-22T16:46:17.9570573+00:00")]
        [DataRow(36, 27.7764768693596, 56.6650581359863, -2326692.61347873, 11639727.1424781, 25.4027303148217, 58.3694049201137, -3576428.77788792, 11431944.2795257, "2023-02-22T16:46:57.7741634+00:00")]
        [DataRow(37, 160.170414838474, 108.593780517578, -10897608.1212881, -4389196.42341118, 161.274297801183, 107.882635426048, -11050802.1401184, -3914146.14885643, "2023-02-22T16:47:33.3789428+00:00")]
        [DataRow(38, 166.957052564248, 130.054588317871, 7152803.69502901, -9904122.47596046, 167.699808075733, 132.505309164462, 8679639.19245728, -8432986.69565104, "2023-02-22T16:47:51.8233376+00:00")]
        [DataRow(39, 180.642392088193, 159.463901519775, 10349540.867592, 183864.092471194, 180.64244012648, 159.463901519775, 10349540.5896989, 183877.838664585, "2023-02-26T21:05:39.0586382+00:00")]
        [DataRow(40, 187.496527047362, 163.621063232422, 9837826.67216066, 1920792.19567023, 187.49534086064, 163.621063232422, 9837893.52708983, 1920496.56004675, "2023-02-26T21:06:37.6198267+00:00")]

        [DataTestMethod]
        public void TestSP2CSRoundTip(int id, double unsyncedRA, double unsyncedDec, double unsynchedX, double unsyncedY, double syncedRA, double syncedDec, double synchedX, double syncedY, string syncTime)
        {
            AxisPosition testInput = new AxisPosition(unsyncedRA, unsyncedDec);
            CartesCoord resultC = _alignmentModel.EQ_sp2Cs(testInput);
            AxisPosition resultAp = _alignmentModel.EQ_cs2Sp(resultC, resultC);
            Assert.AreEqual(testInput.RA, resultAp.RA, DoubleDelta, "RAs differ!");
            Assert.AreEqual(testInput.Dec, resultAp.Dec, DoubleDelta, "Decs differ!");

        }





    }
}
